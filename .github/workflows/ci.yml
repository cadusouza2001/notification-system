name: CI

on:
  push:
    branches: ["master"]
  pull_request:

permissions:
  contents: write
  checks: write

jobs:
  backend-test:
    name: Backend - Format, Test, Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: "maven"

      # 1. Auto-format and commit
      - name: Apply Code Formatting (Spotless)
        run: mvn -f backend/pom.xml -B -q spotless:apply

      - name: Commit formatting changes (backend)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style(backend): apply Spotless [skip ci]"
          file_pattern: backend/**/*

      # 2. Run Tests & Generate JaCoCo Report
      - name: Run Tests & JaCoCo
        run: mvn -B -q -f backend/pom.xml test jacoco:report

      # 3. Generate Coverage Badge and commit
      - name: Generate JaCoCo Badge
        id: jacoco
        uses: cicirello/jacoco-badge-generator@v2
        with:
          jacoco-csv-file: backend/target/site/jacoco/jacoco.csv
          badges-directory: .github/badges
          generate-branches-badge: true
          generate-summary: true

      - name: Commit coverage badge
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update coverage badges [skip ci]"
          file_pattern: .github/badges/*

      - name: Upload JaCoCo HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: backend/target/site/jacoco

  frontend-test:
    name: Frontend - Format, Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      # 1. Auto-format and commit
      - name: Apply Code Formatting (Prettier)
        working-directory: frontend
        run: npm run format:fix

      - name: Commit formatting changes (frontend)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style(frontend): apply Prettier [skip ci]"
          file_pattern: frontend/**/*

      # 2. Start dev server and run tests
      - name: Start dev server
        working-directory: frontend
        run: nohup npm run dev -- --port 5173 --host 127.0.0.1 --strictPort >/dev/null 2>&1 &

      - name: Wait for dev server
        run: npx wait-on --timeout 120000 http-get://127.0.0.1:5173/

      - name: Run Cypress Tests
        working-directory: frontend
        run: npm test

      - name: Upload Cypress artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-artifacts
          path: |
            frontend/cypress/screenshots
            frontend/cypress/videos
            frontend/coverage
          if-no-files-found: ignore
